<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#2563eb" />
    
    <!-- Default meta tags (will be replaced by script below for specific posts) -->
    <meta name="description" content="Social Engagement Hub for Webflow" />
    <title>Social Engagement Hub</title>
    
    <!-- Dynamic meta tag injection for social media crawlers -->
    <script>
      (async function() {
        const path = window.location.pathname;
        const xanoBaseUrl = 'https://xajo-bs7d-cagt.n7e.xano.io/api:iZd1_fI5';
        
        // Helper function to extract plain text from HTML
        function getPlainText(html) {
          if (!html) return '';
          const div = document.createElement('div');
          div.innerHTML = html;
          return (div.textContent || div.innerText || '').substring(0, 200);
        }
        
        // Helper function to extract first image from HTML
        function getFirstImage(html) {
          if (!html) return null;
          const div = document.createElement('div');
          div.innerHTML = html;
          const img = div.querySelector('img');
          return img ? img.src : null;
        }
        
        // Helper function to set meta tags
        function setMetaTags(title, description, image, url) {
          document.title = title;
          
          // Update or create meta tags
          const metaTags = [
            { name: 'description', content: description },
            { property: 'og:type', content: 'article' },
            { property: 'og:url', content: url },
            { property: 'og:title', content: title },
            { property: 'og:description', content: description },
            { property: 'og:site_name', content: 'Social Engagement Hub' },
            { property: 'twitter:card', content: 'summary_large_image' },
            { property: 'twitter:url', content: url },
            { property: 'twitter:title', content: title },
            { property: 'twitter:description', content: description }
          ];
          
          if (image) {
            metaTags.push({ property: 'og:image', content: image });
            metaTags.push({ property: 'twitter:image', content: image });
          }
          
          metaTags.forEach(tag => {
            let meta = document.querySelector(`meta[${tag.name ? 'name' : 'property'}="${tag.name || tag.property}"]`);
            if (!meta) {
              meta = document.createElement('meta');
              if (tag.name) meta.setAttribute('name', tag.name);
              if (tag.property) meta.setAttribute('property', tag.property);
              document.head.appendChild(meta);
            }
            meta.setAttribute('content', tag.content);
          });
        }
        
        // Check if it's a newsfeed post
        const newsfeedMatch = path.match(/^\/newsfeed\/post\/(\d+)/);
        if (newsfeedMatch) {
          try {
            const postId = newsfeedMatch[1];
            const response = await fetch(`${xanoBaseUrl}/newsfeed_post?type=posts_only`);
            const data = await response.json();
            const posts = Array.isArray(data) ? data : (data.posts || []);
            const post = posts.find(p => p.id === parseInt(postId));
            
            if (post) {
              const title = `${post.author_name}'s Post`;
              const description = getPlainText(post.content);
              const image = getFirstImage(post.content);
              const url = window.location.href;
              setMetaTags(title, description, image, url);
            }
          } catch (error) {
            console.error('Error loading newsfeed post meta:', error);
          }
        }
        
        // Check if it's a blog post
        const blogMatch = path.match(/^\/blog\/(\d+)/);
        if (blogMatch) {
          try {
            const postId = blogMatch[1];
            const response = await fetch(`${xanoBaseUrl}/blog_posts/${postId}`);
            const data = await response.json();
            const post = data.post || data;
            
            if (post) {
              const title = post.title || 'Blog Post';
              const description = getPlainText(post.content);
              const image = getFirstImage(post.content);
              const url = window.location.href;
              setMetaTags(title, description, image, url);
            }
          } catch (error) {
            console.error('Error loading blog post meta:', error);
          }
        }
      })();
    </script>
    
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html>
