<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Post</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f9fafb;
            padding: 0;
            margin: 0;
        }
        
        .post-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .post-header {
            padding: 40px 40px 20px 40px;
        }
        
        .post-title {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            line-height: 1.3;
        }
        
        .post-meta {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .post-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .featured-badge {
            display: inline-block;
            background: #fbbf24;
            color: #78350f;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .post-content {
            padding: 0 40px 40px 40px;
            font-size: 18px;
            line-height: 1.8;
            color: #374151;
            overflow-wrap: anywhere;
            word-break: break-word;
            hyphens: auto;
            white-space: normal;
            overflow: visible;
        }
        
        /* Ensure text wraps around floated images */
        .post-content::after {
            content: "";
            display: table;
            clear: both;
        }
        
        .post-content > * {
            clear: none;
        }
        
        .post-content [style*="white-space:nowrap"],
        .post-content [style*="white-space: nowrap"] {
            white-space: normal !important;
        }
        
        .post-content nobr {
            white-space: normal !important;
        }
        
        .post-content p {
            margin-bottom: 20px;
        }
        
        .post-content h1,
        .post-content h2,
        .post-content h3,
        .post-content h4,
        .post-content h5,
        .post-content h6 {
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 700;
            line-height: 1.3;
            color: #111827;
        }
        
        .post-content h2 {
            font-size: 28px;
        }
        
        .post-content h3 {
            font-size: 24px;
        }
        
        .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Support for inline float styles */
        .post-content img[style*="float: left"],
        .post-content img[style*="float:left"] {
            float: left !important;
            margin: 0 20px 15px 0 !important;
            max-width: 45%;
        }
        
        .post-content img[style*="float: right"],
        .post-content img[style*="float:right"] {
            float: right !important;
            margin: 0 0 15px 20px !important;
            max-width: 45%;
        }
        
        /* Image size classes */
        .post-content img.size-small {
            width: 200px;
            max-width: 100%;
        }
        
        .post-content img.size-medium {
            width: 400px;
            max-width: 100%;
        }
        
        .post-content img.size-large {
            width: 600px;
            max-width: 100%;
        }
        
        .post-content img.size-full {
            width: 100%;
        }
        
        /* Image position classes - apply to all sizes */
        .post-content img.position-left,
        .post-content .media-wrapper.position-left,
        .post-content .position-left {
            float: left !important;
            margin: 0 20px 15px 0 !important;
            clear: left;
            max-width: 45%;
            display: block;
        }
        
        .post-content img.position-right,
        .post-content .media-wrapper.position-right,
        .post-content .position-right {
            float: right !important;
            margin: 0 0 15px 20px !important;
            clear: right;
            max-width: 45%;
            display: block;
        }
        
        .post-content img.position-center,
        .post-content .media-wrapper.position-center,
        .post-content .position-center {
            display: block;
            margin: 15px auto;
            float: none;
            max-width: 100%;
        }
        
        /* Wrap position classes for text wrapping around images */
        .post-content img.position-wrap-left,
        .post-content .media-wrapper.position-wrap-left {
            float: left !important;
            margin: 0 20px 15px 0 !important;
            max-width: 45%;
            display: block;
        }
        
        .post-content img.position-wrap-right,
        .post-content .media-wrapper.position-wrap-right {
            float: right !important;
            margin: 0 0 15px 20px !important;
            max-width: 45%;
            display: block;
        }
        
        /* Clear floats to prevent container collapse */
        .post-content::after {
            content: "";
            display: table;
            clear: both;
        }
        
        /* Responsive: remove floats on mobile */
        @media (max-width: 768px) {
            .post-content img.position-left,
            .post-content img.position-right,
            .post-content img.position-wrap-left,
            .post-content img.position-wrap-right,
            .post-content .media-wrapper.position-left,
            .post-content .media-wrapper.position-right,
            .post-content .position-left,
            .post-content .position-right {
                float: none;
                max-width: 100%;
                margin: 12px 0;
            }
        }
        
        .post-content a {
            color: #2563eb;
            text-decoration: underline;
        }
        
        .post-content a:hover {
            color: #1d4ed8;
        }
        
        .post-content ul,
        .post-content ol {
            margin: 20px 0;
            padding-left: 30px;
        }
        
        .post-content li {
            margin-bottom: 10px;
        }
        
        .post-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            color: #6b7280;
        }
        
        .post-content code {
            background-color: #f3f4f6;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
        }
        
        .post-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .post-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        
        /* Ensure iframes accept pointer events for video controls */
        .post-content iframe {
            pointer-events: auto !important;
        }
        
        /* Preserve XANO HTML formatting */
        .post-content font {
            /* Allow font tags to use their color and face attributes */
        }
        
        .post-content span[style*="font-weight: 700"],
        .post-content span[style*="font-weight:700"] {
            font-weight: 700 !important;
        }
        
        .post-content span[style*="font-style: italic"],
        .post-content span[style*="font-style:italic"] {
            font-style: italic !important;
        }
        
        .loading {
            text-align: center;
            padding: 100px 40px;
            color: #6b7280;
            font-size: 18px;
        }
        
        .error {
            text-align: center;
            padding: 100px 40px;
            color: #dc2626;
            font-size: 18px;
        }
        
        .back-link {
            display: inline-block;
            color: #2563eb;
            text-decoration: none;
            padding: 10px 20px;
            margin: 20px 40px;
            border: 1px solid #2563eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .back-link:hover {
            background: #2563eb;
            color: white;
        }
    </style>
</head>
<body>
    <div class="post-container">
        <div id="post-content">
            <div class="loading">Loading post...</div>
        </div>
    </div>

    <script>
        (function() {
            const XANO_URL = '/xano/asset';
            
            // Get post ID from URL parameter
            function getPostId() {
                const params = new URLSearchParams(window.location.search);
                return params.get('id');
            }
            
            function extractImage(html) {
                if (!html) return null;
                try {
                    const tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    const img = tmp.querySelector('img');
                    return img ? img.src : null;
                } catch (e) {
                    return null;
                }
            }
            
            function cleanContent(html, removeFirstImage) {
                if (!html) return '';
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Neutralize <nobr> tags by unwrapping them
                tempDiv.querySelectorAll('nobr').forEach(function(n) {
                    const parent = n.parentNode;
                    while (n.firstChild) {
                        parent.insertBefore(n.firstChild, n);
                    }
                    n.remove();
                });
                
                // Replace non-breaking spaces (U+00A0) with regular spaces in text nodes
                const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT);
                let node;
                while ((node = walker.nextNode())) {
                    if (node.nodeValue && node.nodeValue.indexOf('\u00A0') !== -1) {
                        node.nodeValue = node.nodeValue.replace(/\u00A0+/g, ' ');
                    }
                }
                
                // Unwrap Word's <o:p> tags
                tempDiv.querySelectorAll('o\\:p').forEach(function(el) {
                    const parent = el.parentNode;
                    while (el.firstChild) {
                        parent.insertBefore(el.firstChild, el);
                    }
                    el.remove();
                });
                
                // Normalize YouTube iframes and add required attributes
                const allowedIframeDomains = ['youtube.com', 'youtu.be', 'vimeo.com', 'player.vimeo.com'];
                const iframes = tempDiv.querySelectorAll('iframe');
                iframes.forEach(function(iframe) {
                    const src = iframe.getAttribute('src');
                    if (src) {
                        const isAllowed = allowedIframeDomains.some(function(domain) {
                            return src.indexOf(domain) !== -1;
                        });
                        if (!isAllowed) {
                            iframe.remove();
                        } else {
                            var normalizedSrc = src;
                            
                            // Convert YouTube watch URLs to embed URLs
                            if (src.indexOf('youtube.com/watch') !== -1) {
                                try {
                                    var url = new URL(src);
                                    var videoId = url.searchParams.get('v');
                                    if (videoId) {
                                        normalizedSrc = 'https://www.youtube.com/embed/' + videoId + '?controls=1&modestbranding=1&rel=0';
                                    }
                                } catch (e) {
                                    // Keep original src if URL parsing fails
                                }
                            } else if (src.indexOf('youtu.be/') !== -1) {
                                var videoId = src.split('youtu.be/')[1];
                                if (videoId) {
                                    videoId = videoId.split('?')[0];
                                    normalizedSrc = 'https://www.youtube.com/embed/' + videoId + '?controls=1&modestbranding=1&rel=0';
                                }
                            }
                            
                            iframe.setAttribute('src', normalizedSrc);
                            iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen');
                            iframe.setAttribute('allowfullscreen', '');
                            iframe.setAttribute('frameborder', '0');
                            iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
                            iframe.style.pointerEvents = 'auto';
                        }
                    }
                });
                
                // Remove first image if requested (to avoid duplication with featured image)
                if (removeFirstImage) {
                    const firstImg = tempDiv.querySelector('img');
                    if (firstImg) {
                        firstImg.remove();
                    }
                }
                
                // Remove empty paragraphs (but keep those with images or br tags)
                const paragraphs = tempDiv.querySelectorAll('p');
                paragraphs.forEach(function(p) {
                    const hasMedia = !!p.querySelector('img, br, video, audio, iframe');
                    const text = (p.textContent || '').replace(/\u00A0/g, ' ').trim();
                    if (!hasMedia && text === '') {
                        p.remove();
                    }
                });
                
                return tempDiv.innerHTML;
            }
            
            function displayPost(post) {
                const container = document.getElementById('post-content');
                
                if (!post) {
                    container.innerHTML = '<div class="error">Post not found.</div>';
                    return;
                }
                
                const imageUrl = extractImage(post.description);
                const featuredBadge = post.is_featured ? '<span class="featured-badge">FEATURED</span>' : '';
                const date = new Date(post.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const content = cleanContent(post.description, !!imageUrl);
                
                container.innerHTML = `
                    <div class="post-header">
                        <div class="post-title">
                            ${post.title || 'Untitled'}
                            ${featuredBadge}
                        </div>
                        <div class="post-meta">
                            <div class="post-meta-item">
                                <span>ðŸ‘¤</span>
                                <span>${post.submitted_by || 'Unknown'}</span>
                            </div>
                            <div class="post-meta-item">
                                <span>ðŸ“…</span>
                                <span>${date}</span>
                            </div>
                        </div>
                        ${imageUrl ? `<img src="${imageUrl}" alt="${post.title || 'Post image'}" class="post-image">` : ''}
                    </div>
                    <div class="post-content">
                        ${content}
                    </div>
                `;
            }
            
            function loadPost() {
                const postId = getPostId();
                const container = document.getElementById('post-content');
                
                if (!postId) {
                    container.innerHTML = '<div class="error">No post ID provided.</div>';
                    return;
                }
                
                fetch(XANO_URL)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('HTTP error! status: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function(assets) {
                        // Find the post with matching ID
                        const post = assets.find(function(p) {
                            return p.id === parseInt(postId);
                        });
                        
                        if (!post) {
                            container.innerHTML = '<div class="error">Post not found.</div>';
                            return;
                        }
                        
                        displayPost(post);
                    })
                    .catch(function(error) {
                        console.error('Error loading post:', error);
                        container.innerHTML = '<div class="error">Error loading post: ' + error.message + '</div>';
                    });
            }
            
            // Load post when page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadPost);
            } else {
                loadPost();
            }
        })();
    </script>
</body>
</html>
