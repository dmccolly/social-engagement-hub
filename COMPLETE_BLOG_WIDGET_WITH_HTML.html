<div id="blog-widget" class="blog-widget">
  <div class="blog-loading">Loading blog posts...</div>
</div>

<!-- Auth Modal -->
<div class="modal-overlay" id="auth-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>Welcome!</h2>
    </div>
    <div class="modal-body">
      <p>To participate in our community, please tell us a bit about yourself. We'll remember you for next time!</p>
      <form id="auth-form">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="first-name" required placeholder="John">
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="last-name" required placeholder="Doe">
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="email" required placeholder="john@example.com">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAuthModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitAuth()">Continue</button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // Get API URL and post base from data attributes or use defaults
  const currentScript = document.currentScript || document.querySelector('script[data-api]');
  const API_URL = currentScript?.getAttribute('data-api') || 
    'https://gleaming-cendol-417bf3.netlify.app/.netlify/functions/blog-posts';
  const POST_BASE = currentScript?.getAttribute('data-post-base') || 
    'https://historyofidahobroadcasting.org/social';
  
  const NEWSFEED_URL = 'https://xajo-bs7d-cagt.n7e.xano.io/api:PpStJiYV/newsfeed_post';
  
  const ADMIN_EMAILS = [
    'dmccolly@gmail.com',
    'danmccolly@gmail.com',
    'admin@historyofidahobroadcasting.org',
    'dan@historyofidahobroadcasting.org',
    'contact@historyofidahobroadcasting.org',
    'art@historyofidahobroadcasting.org',
    'info@historyofidahobroadcasting.org'
  ];
  
  let visitorSession = null;
  let commentEditors = {};
  let deleteConfirmId = null;
  let pendingCommentPostId = null;
  
  console.log('‚úÖ Blog widget with comments initialized');
  console.log('Blog widget API URL:', API_URL);
  
  // Load visitor session
  function loadVisitorSession() {
    try {
      const saved = localStorage.getItem('visitor_session');
      if (saved) {
        visitorSession = JSON.parse(saved);
      }
    } catch (e) {
      console.error('Failed to load visitor session', e);
    }
  }
  
  // Show auth modal
  function showAuthModal(postId) {
    pendingCommentPostId = postId;
    document.getElementById('auth-modal').classList.add('active');
  }
  
  // Close auth modal
  window.closeAuthModal = function() {
    document.getElementById('auth-modal').classList.remove('active');
    pendingCommentPostId = null;
  };
  
  // Submit authentication
  window.submitAuth = function() {
    const firstName = document.getElementById('first-name').value.trim();
    const lastName = document.getElementById('last-name').value.trim();
    const email = document.getElementById('email').value.trim();
    
    if (!firstName || !lastName || !email) {
      alert('Please fill in all fields');
      return;
    }
    
    const fullName = firstName + ' ' + lastName;
    const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
    
    visitorSession = {
      name: fullName,
      email: email,
      session_id: sessionId,
      authenticated_at: new Date().toISOString()
    };
    
    localStorage.setItem('visitor_session', JSON.stringify(visitorSession));
    closeAuthModal();
    
    // Update all comment form headers
    document.querySelectorAll('.comment-form-header').forEach(updateCommentFormHeader);
    
    // If there was a pending comment, try to post it
    if (pendingCommentPostId) {
      const postId = pendingCommentPostId;
      pendingCommentPostId = null;
      // User will need to click post again
    }
  };
  
  // Update comment form header
  function updateCommentFormHeader(headerEl) {
    if (visitorSession) {
      headerEl.innerHTML = 'Commenting as <strong>' + escapeHtml(visitorSession.name) + '</strong>';
    } else {
      headerEl.textContent = "You'll be asked to sign in before posting your comment.";
    }
  }
  
  // Format date
  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + 'm ago';
    if (diffHours < 24) return diffHours + 'h ago';
    if (diffDays < 7) return diffDays + 'd ago';
    
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }
  
  // Check if user is admin
  function isAdmin() {
    return visitorSession && ADMIN_EMAILS.includes(visitorSession.email.toLowerCase());
  }
  
  // Load comments for a post
  async function loadComments(postId) {
    const listEl = document.getElementById(`comments-list-${postId}`);
    if (!listEl) return;
    
    listEl.innerHTML = '<div class="blog-loading" style="padding: 20px;">Loading comments...</div>';
    
    try {
      const response = await fetch(`${NEWSFEED_URL}/${postId}/replies`);
      if (!response.ok) throw new Error('Failed to load comments');
      
      const data = await response.json();
      const comments = data.replies || [];
      comments.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      
      document.getElementById(`comments-count-${postId}`).textContent = comments.length;
      
      if (comments.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No comments yet. Be the first to share your thoughts!</p></div>';
      } else {
        listEl.innerHTML = comments.map(comment => createCommentHTML(comment)).join('');
      }
    } catch (error) {
      console.error('Error loading comments:', error);
      listEl.innerHTML = '<div class="blog-error">Failed to load comments</div>';
    }
  }
  
  // Create comment HTML
  function createCommentHTML(comment) {
    const initial = comment.author_name ? comment.author_name.charAt(0).toUpperCase() : 'U';
    const deleteBtn = isAdmin() ? 
      `<button class="btn-delete" onclick="handleDelete(${comment.id})">Delete</button>` : '';
    
    const sanitizedContent = DOMPurify.sanitize(comment.content);
    
    return `
      <div class="comment" data-comment-id="${comment.id}">
        <div class="comment-header">
          <div class="comment-author">
            <div class="comment-avatar">${initial}</div>
            <div class="comment-author-info">
              <div class="comment-author-name">${escapeHtml(comment.author_name || 'Anonymous')}</div>
              <div class="comment-date">${formatDate(comment.created_at)}</div>
            </div>
          </div>
          <div class="comment-actions">${deleteBtn}</div>
        </div>
        <div class="comment-content">${sanitizedContent}</div>
      </div>
    `;
  }
  
  // Handle delete
  window.handleDelete = async function(commentId) {
    if (!isAdmin()) {
      alert('Only administrators can delete comments.');
      return;
    }
    
    if (deleteConfirmId !== commentId) {
      deleteConfirmId = commentId;
      const btn = document.querySelector(`[data-comment-id="${commentId}"] .btn-delete`);
      if (btn) {
        btn.textContent = 'Click again to confirm';
        btn.classList.add('confirm');
      }
      setTimeout(() => {
        deleteConfirmId = null;
        if (btn) {
          btn.textContent = 'Delete';
          btn.classList.remove('confirm');
        }
      }, 3000);
      return;
    }
    
    try {
      const response = await fetch(`https://xajo-bs7d-cagt.n7e.xano.io/api:PpStJiYV/newsfeed_replies/${commentId}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) throw new Error('Failed to delete comment');
      
      deleteConfirmId = null;
      
      // Find which post this comment belongs to and reload its comments
      const commentEl = document.querySelector(`[data-comment-id="${commentId}"]`);
      if (commentEl) {
        const postEl = commentEl.closest('.blog-post-item');
        if (postEl) {
          const postId = postEl.id.replace('post-', '');
          loadComments(postId);
        }
      }
    } catch (error) {
      console.error('Error deleting comment:', error);
      alert('Failed to delete comment');
    }
  };
  
  // Post comment
  window.postComment = async function(postId) {
    if (!visitorSession) {
      showAuthModal(postId);
      return;
    }
    
    const editor = commentEditors[postId];
    if (!editor) return;
    
    const content = editor.root.innerHTML;
    const text = editor.getText().trim();
    
    if (!text) {
      alert('Please enter a comment');
      return;
    }
    
    const btn = document.querySelector(`#post-${postId} .btn-primary`);
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Posting...';
    }
    
    const commentData = {
      author_name: visitorSession.name,
      author_email: visitorSession.email,
      content: content,
      parent_id: parseInt(postId),
      session_id: visitorSession.session_id,
      post_type: 'reply'
    };
    
    try {
      const response = await fetch(NEWSFEED_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(commentData)
      });
      
      if (!response.ok) throw new Error('Failed to post comment');
      
      editor.setText('');
      loadComments(postId);
      
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Post Comment';
      }
    } catch (error) {
      console.error('Error posting comment:', error);
      alert('Failed to post comment: ' + error.message);
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Post Comment';
      }
    }
  };
  
  // Initialize comment editor for a post
  function initCommentEditor(postId) {
    const editorEl = document.getElementById(`comment-editor-${postId}`);
    if (!editorEl || commentEditors[postId]) return;
    
    const editor = new Quill(editorEl, {
      theme: 'snow',
      placeholder: 'Share your thoughts...',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          ['link'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }]
        ]
      }
    });
    
    commentEditors[postId] = editor;
  }
  
  async function loadBlogPosts() {
    const container = document.getElementById('blog-widget');
    
    try {
      const response = await fetch(API_URL);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API error:', response.status, errorText);
        throw new Error(`Failed to fetch blog posts: ${response.status} ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('API response:', data);
      
      if (!data.success) {
        throw new Error(data.error || 'Failed to fetch blog posts');
      }
      
      const blogPosts = data.posts || [];
      console.log('Blog posts received:', blogPosts.length);
      
      if (blogPosts.length === 0) {
        container.innerHTML = '<div class="blog-loading">No blog posts found.</div>';
        return;
      }
      
      // Render blog posts
      container.innerHTML = blogPosts.map(post => {
        const title = post.title || 'Untitled';
        const author = post.author || 'Unknown';
        const date = new Date(post.created_at).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        const heroImage = getHeroImage(post);
        const heroImageHtml = heroImage ? 
          `<img src="${escapeHtml(heroImage)}" alt="${escapeHtml(title)}" class="blog-post-hero" loading="lazy">` : '';
        
        const excerpt = createHtmlExcerpt(post.content || '', 400, 5);
        const fullContent = sanitizeContent(post.content || '');
        
        if (!window.blogPostContent) window.blogPostContent = {};
        window.blogPostContent[post.id] = { excerpt, fullContent };
        
        const readMoreHtml = `<button class="blog-read-more" onclick="togglePost(${post.id})">Read more ‚Üí</button>`;
        
        return `
          <div class="blog-post-item" id="post-${post.id}">
            ${heroImageHtml}
            <h2 class="blog-post-title">${escapeHtml(title)}</h2>
            <div class="blog-post-meta">
              By ${escapeHtml(author)} ‚Ä¢ ${date}
            </div>
            <div class="blog-post-content collapsed">${excerpt}</div>
            ${readMoreHtml}
            <div class="comments-section" id="comments-${post.id}" style="display: none;">
              <div class="comments-header">
                <h3>Comments</h3>
                <span class="comments-count" id="comments-count-${post.id}">0</span>
              </div>
              <div class="comment-form">
                <div class="comment-form-header" id="comment-form-header-${post.id}">
                  You'll be asked to sign in before posting your comment.
                </div>
                <div class="comment-editor-container">
                  <div id="comment-editor-${post.id}"></div>
                </div>
                <div class="comment-form-actions">
                  <button class="btn btn-primary" onclick="postComment(${post.id})">Post Comment</button>
                </div>
              </div>
              <div id="comments-list-${post.id}" class="comments-list">
                <div class="blog-loading">Loading comments...</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      console.log('Blog posts rendered successfully');
      
    } catch (error) {
      console.error('Error loading blog posts:', error);
      container.innerHTML = `
        <div class="blog-error">
          <strong>Error loading blog posts:</strong> ${escapeHtml(error.message)}
        </div>
      `;
    }
  }
  
  // Helper function to escape HTML in text fields
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Helper function to get hero image from post
  function getHeroImage(post) {
    if (post.thumbnail_url && post.thumbnail_url.startsWith('http')) {
      return post.thumbnail_url;
    }
    
    if (post.media_url && post.media_url.startsWith('http')) {
      if (post.media_url.includes('cloudinary.com') && post.media_url.includes('/video/upload/')) {
        const posterUrl = post.media_url
          .replace('/video/upload/', '/video/upload/so_0/')
          .replace(/\.(mp4|webm|mov|avi)$/i, '.jpg');
        return posterUrl;
      }
      if (/\.(jpg|jpeg|png|gif|webp)$/i.test(post.media_url)) {
        return post.media_url;
      }
    }
    
    if (post.content) {
      const div = document.createElement('div');
      div.innerHTML = post.content;
      const firstImg = div.querySelector('img');
      if (firstImg && firstImg.src && firstImg.src.startsWith('http')) {
        return firstImg.src;
      }
    }
    
    return null;
  }
  
  // Helper function to create HTML excerpt
  function createHtmlExcerpt(html, minChars = 400, maxBlocks = 5) {
    const div = document.createElement('div');
    div.innerHTML = html || '';
    
    const tagsToRemove = ['img', 'iframe', 'video', 'audio', 'object', 'embed', 'svg', 'canvas', 'script', 'style', 'form', 'link', 'meta'];
    tagsToRemove.forEach(tag => {
      const elements = div.querySelectorAll(tag);
      elements.forEach(el => el.remove());
    });
    
    const allElements = div.querySelectorAll('*');
    allElements.forEach(el => {
      Array.from(el.attributes).forEach(attr => {
        if (attr.name.startsWith('on')) {
          el.removeAttribute(attr.name);
        }
      });
    });
    
    const blockElements = Array.from(div.querySelectorAll('p, ul, ol, blockquote, div, h1, h2, h3, h4, h5, h6'))
      .filter(el => el.textContent.trim().length > 0);
    
    if (blockElements.length === 0) {
      const plainText = (div.textContent || '').trim().replace(/\s+/g, ' ');
      const slice = plainText.slice(0, 280);
      return escapeHtml(`${slice}${plainText.length > 280 ? '‚Ä¶' : ''}`);
    }
    
    const excerptDiv = document.createElement('div');
    let totalChars = 0;
    let blocksAdded = 0;
    
    for (const el of blockElements) {
      if (blocksAdded >= maxBlocks) break;
      if (totalChars >= minChars && blocksAdded > 0) break;
      
      excerptDiv.appendChild(el.cloneNode(true));
      totalChars += el.textContent.trim().length;
      blocksAdded++;
    }
    
    if (blockElements.length > blocksAdded) {
      const ellipsis = document.createElement('span');
      ellipsis.textContent = ' ‚Ä¶';
      excerptDiv.appendChild(ellipsis);
    }
    
    return excerptDiv.innerHTML;
  }
  
  // Function to sanitize full content
  function sanitizeContent(html) {
    const div = document.createElement('div');
    div.innerHTML = html || '';
    
    const tagsToRemove = ['script', 'style', 'form', 'link', 'meta'];
    tagsToRemove.forEach(tag => {
      const elements = div.querySelectorAll(tag);
      elements.forEach(el => el.remove());
    });
    
    const allElements = div.querySelectorAll('*');
    allElements.forEach(el => {
      Array.from(el.attributes).forEach(attr => {
        if (attr.name.startsWith('on')) {
          el.removeAttribute(attr.name);
        }
      });
    });
    
    return div.innerHTML;
  }
  
  // Global function to toggle post expansion
  window.togglePost = function(postId) {
    const postEl = document.getElementById(`post-${postId}`);
    if (!postEl) return;
    
    const contentEl = postEl.querySelector('.blog-post-content');
    const btnEl = postEl.querySelector('.blog-read-more');
    const commentsEl = document.getElementById(`comments-${postId}`);
    if (!contentEl || !btnEl) return;
    
    const isCollapsed = contentEl.classList.contains('collapsed');
    const postContent = window.blogPostContent?.[postId];
    
    if (!postContent) {
      console.error('Post content not found for ID:', postId);
      return;
    }
    
    if (isCollapsed) {
      // Expand - show full content and comments
      contentEl.innerHTML = postContent.fullContent;
      contentEl.classList.remove('collapsed');
      btnEl.textContent = 'Show less ‚Üê';
      
      // Show comments section
      if (commentsEl) {
        commentsEl.style.display = 'block';
        
        // Initialize comment editor if not already done
        if (!commentEditors[postId]) {
          initCommentEditor(postId);
          
          // Update comment form header
          const headerEl = document.getElementById(`comment-form-header-${postId}`);
          if (headerEl) {
            updateCommentFormHeader(headerEl);
          }
        }
        
        // Load comments
        loadComments(postId);
      }
    } else {
      // Collapse - show excerpt and hide comments
      contentEl.innerHTML = postContent.excerpt;
      contentEl.classList.add('collapsed');
      btnEl.textContent = 'Read more ‚Üí';
      
      // Hide comments section
      if (commentsEl) {
        commentsEl.style.display = 'none';
      }
      
      // Scroll to post
      postEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };
  
  // Initialize
  loadVisitorSession();
  
  // Load blog posts when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadBlogPosts);
  } else {
    loadBlogPosts();
  }
  
  console.log('‚úÖ Blog widget initialized');
})();
</script>
